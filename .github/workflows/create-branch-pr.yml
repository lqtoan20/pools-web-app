name: Auto Create Pull Request and Add Team Reviewers

on:
  push:
    branches:
      - main # Change this to the branch you want to trigger the workflow on

jobs:
  create_pull_request:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up date
        # if: steps.verify-changed-files.outputs.files_changed == 'true'
        id: date
        run: echo "::set-output name=date::$(date +'%m-%d-%Y')"

      # - name: Find and close PR not merge
      #   run: |
      #     branch_name="atc-ui-update-$(date -d 'yesterday' +'%m-%d-%Y')"
      #     pr_number=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls?q=head:${branch_name}" | jq -r '.[0].number')
      #     if [ "$pr_number" != "null" ]; then
      #         echo "Found PR with branch name $branch_name: #$pr_number"

      #         echo "Closing PR #$pr_number"
      #         curl -X PATCH -H "Authorization: token $GITHUB_TOKEN" -d '{"state": "closed"}' "https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number"

      #         echo "Deleting branch $branch_name"
      #         curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/$branch_name"
      #     else
      #         echo "No PR found with branch name $branch_name"
      #     fi
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find and Close PR
        run: |
          branch_name="atc-ui-update-$(date -d 'yesterday' +'%m-%d-%Y')"
          pr_number=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls?q=head:${branch_name}" | jq -r '.[0].number')

          if [ "$pr_number" != "null" ]; then
              echo "Found PR with branch name $branch_name: #$pr_number"
              
              pr_branch_name=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number" | jq -r '.head.ref')
              if [ "$pr_branch_name" == "$branch_name" ]; then
                  echo "PR branch name matches: $pr_branch_name"
                  echo "Closing PR #$pr_number"
                  curl -X PATCH -H "Authorization: token $GITHUB_TOKEN" -d '{"state": "closed"}' "https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number"

                  echo "Deleting branch $branch_name"
                  curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/$branch_name"
              else
                  echo "PR branch name does not match: $pr_branch_name"
              fi
          else
              echo "No PR found with branch name $branch_name"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Get Team Members
      #   run: |
      #     organization="toanla2002"
      #     team_slug="testautoadd"

      #     members_json=$(curl -s "https://api.github.com/orgs/$organization/teams/$team_slug/members" -H "Authorization: token $GITHUB_TOKEN")
      #     echo "API Response: $members_json"
      #     members=$(echo "$members_json" | jq -r '.[] | .login')
      #     echo "Team Members for $team_slug in $organization: $members"
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Make changes to pull request
        run: date +%s > report.txt

      - name: Create pull request
        # if: steps.verify-changed-files.outputs.files_changed == 'true'
        uses: peter-evans/create-pull-request@v5
        id: cpr
        with:
          commit-message: Update package version
          title: atc-ui update ${{ steps.date.outputs.date }}
          # labels: atc-ui update
          branch: atc-ui-update-${{ steps.date.outputs.date }}
          # team-reviewers: fyc-atc-ui-approvals
          base: "main"

      - name: Check outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
